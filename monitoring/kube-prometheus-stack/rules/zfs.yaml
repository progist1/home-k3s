apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: zfs-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: zfs.recording
    interval: 30s
    rules:

      # ---- ZFS usage percent ----
      - record: zfs_pool_usage_percent
        expr: |
          (
            zfs_pool_allocated_bytes
            /
            zfs_pool_size_bytes
          ) * 100

  - name: zfs-pool-state
    interval: 30s
    rules:
    # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð»ÐµÑ€Ñ‚: Ð¿ÑƒÐ» Ð½Ðµ Ð² ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸ ONLINE
    # ÐžÑ…Ð²Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð²ÑÐµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ: degraded, faulted, unavail, offline, removed, suspended
    - alert: ZFSPoolNotOnline
      expr: node_zfs_zpool_state{state!="online"} == 1
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "ZFS pool {{ $labels.zpool }} is {{ $labels.state }} on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.zpool }}
          **Status:** {{ $labels.state }}
          **Host:** {{ $labels.hostname }}
          **Action:** âš ï¸ Check `zpool status {{ $labels.zpool }}` immediately!
          **Note:** 
          - DEGRADED: Pool functional but redundancy reduced, replace faulted devices
          - FAULTED: Pool completely unavailable, IMMEDIATE ACTION REQUIRED
          - UNAVAIL: Pool cannot be opened, check device connections
          - OFFLINE: Pool was taken offline, check if safe to bring online
          - REMOVED: Pool was removed, check if intentional
          - SUSPENDED: Pool is suspended, check system state

  - name: zfs-capacity
    interval: 30s
    rules:
    # Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¿ÑƒÐ»Ð° (>80%) Ð´Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð¿ÑƒÐ»Ð¾Ð²
    - alert: ZFSPoolCapacityHigh
      expr: |
        zfs_pool_usage_percent{pool!="Unsafe"} > 80
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "ZFS pool {{ $labels.pool }} is {{ $value | humanize }}% full on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Used:** {{ $value | humanize }}%
          **Allocated:** {{ printf "%.1f" $value }}
          **Host:** {{ $labels.hostname }}
          **Action:** ðŸ—„ï¸ Free up space or expand pool

    # Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¿ÑƒÐ»Ð° (>90%) Ð´Ð»Ñ Unsafe/Media
    - alert: ZFSPoolCapacityHighUnsafeMedia
      expr: |
        zfs_pool_usage_percent{pool="Unsafe"} > 90
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "ZFS pool {{ $labels.pool }} (Unsafe/Media) is {{ $value | humanize }}% full on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Device:** Unsafe/Media
          **Used:** {{ $value | humanize }}%
          **Allocated:** {{ printf "%.1f" $value }}
          **Host:** {{ $labels.hostname }}
          **Action:** ðŸ—„ï¸ Free up space or expand pool

  - name: zfs-capacity-critical
    interval: 30s
    rules:
    # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¿ÑƒÐ»Ð° (>93%)
    - alert: ZFSPoolCapacityCritical
      expr: |
        zfs_pool_usage_percent > 93
      for: 15m
      labels:
        severity: critical
      annotations:
        summary: "ZFS pool {{ $labels.pool }} is {{ $value | humanize }}% full on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Used:** {{ $value | humanize }}%
          **Allocated:** {{ printf "%.1f" $value }}
          **Host:** {{ $labels.hostname }}
          **Action:** ðŸ—„ï¸ Immediate free up space or expand pool

  - name: zfs-performance
    interval: 30s
    rules:
    # Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð¿ÑƒÐ»Ð° (>60%)
    - alert: ZFSPoolFragmentationHigh
      expr: |
        zfs_pool_fragmentation_ratio * 100 > 60
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "ZFS pool {{ $labels.pool }} fragmentation high on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Fragmentation:** {{ $value | humanize }}%
          **Host:** {{ $labels.hostname }}
          **Action:** ðŸ’¾ Consider pool scrub and balance

    # ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð´ÐµÐ´ÑƒÐ¿Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ (ratio < 1.0)
    - alert: ZFSDeduplicationIssue
      expr: |
        zfs_pool_deduplication_ratio < 1.0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "ZFS pool {{ $labels.pool }} dedup ratio abnormal on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Deduplication ratio:** {{ $value }}
          **Host:** {{ $labels.hostname }}
          **Issue:** ðŸ§¹ Deduplication table may be corrupted

  - name: zfs-health-met
    interval: 30s
    rules:
    # Health Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ° Ð¾Ñ‚ zfs-exporter
    # 0: ONLINE, 1: DEGRADED, 2: FAULTED, 3: OFFLINE, 4: UNAVAIL, 5: REMOVED, 6: SUSPENDED
    - alert: ZFSPoolHealthDegraded
      expr: zfs_pool_health == 1
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "ZFS pool {{ $labels.pool }} is DEGRADED (health=1) on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Health:** DEGRADED (value: 1)
          **Host:** {{ $labels.hostname }}
          **Action:** âš ï¸ Check `zpool status {{ $labels.pool }}` - one or more devices may be faulted or have errors

    - alert: ZFSPoolHealthFaulted
      expr: zfs_pool_health == 2
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "ZFS pool {{ $labels.pool }} is FAULTED (health=2) on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Health:** FAULTED (value: 2)
          **Host:** {{ $labels.hostname }}
          **Action:** ðŸš¨ IMMEDIATE ACTION REQUIRED! Pool is completely unavailable. Check `zpool status {{ $labels.pool }}`

    - alert: ZFSPoolHealthUnavailable
      expr: zfs_pool_health >= 3
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "ZFS pool {{ $labels.pool }} health is {{ $value }} (OFFLINE/UNAVAIL/REMOVED/SUSPENDED) on {{ $labels.hostname }}"
        description: |
          **Pool:** {{ $labels.pool }}
          **Health value:** {{ $value }}
          **Host:** {{ $labels.hostname }}
          **Health codes:** 3=OFFLINE, 4=UNAVAIL, 5=REMOVED, 6=SUSPENDED
          **Action:** ðŸš¨ Check `zpool status {{ $labels.pool }}` immediately!

    - alert: ZFSPoolWillFillSoon
      expr: |
        predict_linear(
          zfs_pool_used_bytes[7d],
          7 * 24 * 3600
        )
        >
        zfs_pool_size_bytes
      for: 30m
      labels:
        severity: warning
      annotations:
        summary: "ZFS pool {{ $labels.pool }} will be full within 7 days"
        description: |
          Based on last week growth trend,
          pool is predicted to run out of space within 7 days.
