apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-storage-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: pvc
    interval: 30s
    rules:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç - PVC –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ Pending
    - alert: PVCPending
      expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} == 1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PVC {{ $labels.persistentvolumeclaim }} is Pending in namespace {{ $labels.namespace }}"
        description: "PVC {{ $labels.persistentvolumeclaim }} has been in Pending state for more than 5 minutes. Check storage class and available storage."

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –º–∞–ª–æ –º–µ—Å—Ç–∞ –≤ PVC (<10%)
    - alert: PVCLowSpace
      expr: |
        (
          (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) * 100 < 10
        )
        and
        kubelet_volume_stats_capacity_bytes > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "PVC {{ $labels.persistentvolumeclaim }} is running low on space"
        description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} has only {{ $value | humanize }}% free space remaining."

    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç - –æ—á–µ–Ω—å –º–∞–ª–æ –º–µ—Å—Ç–∞ –≤ PVC (<5%)
    - alert: PVCCriticalSpace
      expr: |
        (
          (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) * 100 < 5
        )
        and
        kubelet_volume_stats_capacity_bytes > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "üö® PVC {{ $labels.persistentvolumeclaim }} is critically low on space"
        description: "PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }} has only {{ $value | humanize }}% free space remaining. Immediate action required!"

