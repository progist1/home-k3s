apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: k8up-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: k8up.backup
    interval: 30s
    rules:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç - –æ—à–∏–±–∫–∏ –≤–æ –≤—Ä–µ–º—è –±—ç–∫–∞–ø–∞
    - alert: K8upBackupErrors
      expr: k8up_backup_restic_last_errors > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "K8up backup errors detected ({{ $labels.namespace }}/{{ $labels.pvc }})"
        description: |
          K8up backup job has errors for PVC {{ $labels.pvc }} in namespace {{ $labels.namespace }}.
          **Errors:** {{ $value }}
          **Instance:** {{ $labels.instance }}
          **Job:** {{ $labels.exported_job }}
          **Action:** üîç Check backup job logs and restic repository

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫ k8up
    - alert: K8upMetricsMissing
      expr: absent(k8up_backup_restic_available_snapshots)
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "K8up metrics are missing"
        description: |
          No K8up backup metrics have been collected for more than 1 hour.
          **Action:** üîç Check if K8up jobs are running and promURL is configured correctly

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - —Å–ª–∏—à–∫–æ–º –º–∞–ª–æ —Å–Ω—ç–ø—à–æ—Ç–æ–≤
    - alert: K8upLowSnapshotCount
      expr: k8up_backup_restic_available_snapshots < 3
      for: 30m
      labels:
        severity: warning
      annotations:
        summary: "K8up low snapshot count ({{ $labels.instance }})"
        description: |
          K8up has less than 3 snapshots available for instance {{ $labels.instance }}.
          **Snapshots:** {{ $value }}
          **Job:** {{ $labels.exported_job }}
          **Action:** ‚ö†Ô∏è Check backup schedule and retention policy

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–ª–µ—Ä—Ç - –º–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤–æ –≤—Ä–µ–º—è –±—ç–∫–∞–ø–∞
    - alert: K8upHighFileChanges
      expr: k8up_backup_restic_changed_files_during_backup > 10000
      for: 5m
      labels:
        severity: info
      annotations:
        summary: "K8up high file changes during backup ({{ $labels.namespace }}/{{ $labels.pvc }})"
        description: |
          K8up backup detected high number of changed files during last backup.
          **Changed files:** {{ $value }}
          **PVC:** {{ $labels.pvc }}
          **Namespace:** {{ $labels.namespace }}
          **Action:** ‚ÑπÔ∏è This might indicate high data churn

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–ª–µ—Ä—Ç - –º–Ω–æ–≥–æ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –≤–æ –≤—Ä–µ–º—è –±—ç–∫–∞–ø–∞
    - alert: K8upHighNewFiles
      expr: k8up_backup_restic_new_files_during_backup > 5000
      for: 5m
      labels:
        severity: info
      annotations:
        summary: "K8up high new files during backup ({{ $labels.namespace }}/{{ $labels.pvc }})"
        description: |
          K8up backup detected high number of new files during last backup.
          **New files:** {{ $value }}
          **PVC:** {{ $labels.pvc }}
          **Namespace:** {{ $labels.namespace }}
          **Action:** ‚ÑπÔ∏è Monitor backup size growth

  - name: k8up.backup.health
    interval: 1m
    rules:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç - –Ω–µ—Ç –º–µ—Ç—Ä–∏–∫ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ PVC –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
    - alert: K8upBackupStale
      expr: |
        (
          time() - (
            max by (namespace, pvc) (
              k8up_backup_restic_changed_files_during_backup
            )
          )
        ) > 86400  # 24 hours
      for: 1h
      labels:
        severity: critical
      annotations:
        summary: "K8up backup is stale ({{ $labels.namespace }}/{{ $labels.pvc }})"
        description: |
          No backup activity detected for PVC {{ $labels.pvc }} in namespace {{ $labels.namespace }} for more than 24 hours.
          **Action:** üö® Check backup schedule and job status

  - name: k8up.operator
    interval: 30s
    rules:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç - –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ k8up
    - alert: K8upControllerErrors
      expr: increase(controller_runtime_reconcile_errors_total{controller=~".*k8up.*"}[5m]) > 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "K8up controller errors ({{ $labels.controller }})"
        description: |
          K8up controller {{ $labels.controller }} has reconciliation errors.
          **Errors:** {{ $value }}
          **Controller:** {{ $labels.controller }}
          **Action:** üîç Check controller logs and CRD resources

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –≤—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –¥–∂–æ–±
    - alert: K8upHighJobFailureRate
      expr: |
        (
          (k8up_jobs_total - on(jobType, namespace) k8up_jobs_successful_counter) 
          / on(jobType, namespace) k8up_jobs_total
        ) > 0.1
        and on(jobType, namespace) k8up_jobs_total > 10
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "K8up high job failure rate ({{ $labels.jobType }}/{{ $labels.namespace }})"
        description: |
          K8up has high failure rate for {{ $labels.jobType }} jobs in namespace {{ $labels.namespace }}.
          **Failure rate:** {{ $value | humanizePercentage }}
          **Total jobs:** {{ $labels.jobType }}
          **Action:** ‚ö†Ô∏è Check job logs and backup configuration

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ - –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
    - alert: K8upOperatorMetricsMissing
      expr: absent(k8up_schedules_gauge)
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "K8up operator metrics are missing"
        description: |
          No K8up operator metrics have been collected for more than 5 minutes.
          **Action:** üîç Check if k8up operator is running and ServiceMonitor is configured correctly
