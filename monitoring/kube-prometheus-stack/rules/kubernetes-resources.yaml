apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-resources-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: resources
    interval: 30s
    rules:
    # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð»ÐµÑ€Ñ‚ - Pod Ð±Ñ‹Ð» ÑƒÐ±Ð¸Ñ‚ Ð¸Ð·-Ð·Ð° OOM
    - alert: PodOOMKilled
      expr: |
        increase(container_oom_events_total[5m]) > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "ðŸš¨ Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} was OOMKilled"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} (namespace {{ $labels.namespace }}) was killed due to OOM. Increase memory limits or investigate memory leaks."

    # ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ - Ð²Ñ‹ÑÐ¾ÐºÐ¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸ (>80% Ð¾Ñ‚ limit)
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ container_memory_usage_bytes Ð¸ kube_pod_container_resource_limits
    - alert: PodHighMemoryUsage
      expr: |
        (
          avg by(pod, container, namespace) (container_memory_usage_bytes{container!="POD",container!="",namespace=~"apps|infra"})
          / 
          on(pod, container, namespace) 
          max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="memory",container!="POD",container!=""})
        ) * 100 > 80
        and
        max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="memory",container!="POD",container!=""}) > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.pod }} is using {{ $value | humanize }}% of memory limit"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} (namespace {{ $labels.namespace }}) is using {{ $value | humanize }}% of its memory limit. Consider increasing limits or optimizing memory usage."

    # ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ - Ð²Ñ‹ÑÐ¾ÐºÐ¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ CPU (>80% Ð¾Ñ‚ limit)
    - alert: PodHighCPUUsage
      expr: |
        (
          rate(container_cpu_usage_seconds_total{container!="POD",container!="",namespace=~"apps|infra"}[5m]) 
          / 
          on(pod, container, namespace) 
          max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="cpu",container!="POD",container!=""})
        ) * 100 > 80
        and
        max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="cpu",container!="POD",container!=""}) > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.pod }} is using {{ $value | humanize }}% of CPU limit"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} (namespace {{ $labels.namespace }}) is using {{ $value | humanize }}% of its CPU limit. Consider increasing limits or optimizing CPU usage."

