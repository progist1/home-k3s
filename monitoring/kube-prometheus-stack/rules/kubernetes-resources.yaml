apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-resources-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: resources
    interval: 30s
    rules:
    # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð»ÐµÑ€Ñ‚ - Pod Ð±Ñ‹Ð» ÑƒÐ±Ð¸Ñ‚ Ð¸Ð·-Ð·Ð° OOM
    - alert: PodOOMKilled
      expr: |
        increase(container_oom_events_total[5m]) > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "ðŸš¨ Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} was OOMKilled"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} (namespace {{ $labels.namespace }}) was killed due to OOM. Increase memory limits or investigate memory leaks."

    # ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ - Ð²Ñ‹ÑÐ¾ÐºÐ¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸ (>80% Ð¾Ñ‚ limit)
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ container_memory_working_set_bytes (Ñ€ÐµÐ°Ð»ÑŒÐ½Ð°Ñ Ð¿Ð°Ð¼ÑÑ‚ÑŒ Ð±ÐµÐ· ÐºÐµÑˆÐ°)
    # Ð­Ñ‚Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ, Ð° Ð½Ðµ ÐºÐµÑˆ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
    # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ max_over_time Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð´Ð¾ Ñ€ÐµÑÑ‚Ð°Ñ€Ñ‚Ð°
    - alert: PodHighMemoryUsage
      expr: |
        (
          max_over_time(container_memory_working_set_bytes{container!="POD",container!="",namespace=~"apps|infra"}[5m])
          / 
          on(pod, container, namespace) 
          max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="memory",container!="POD",container!=""})
        ) * 100 > 80
        and
        max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="memory",container!="POD",container!=""}) > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.pod }} is using {{ $value | humanize }}% of memory limit"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} (namespace {{ $labels.namespace }}) is using {{ $value | humanize }}% of its memory limit (working set, excluding cache). Consider increasing limits or optimizing memory usage."

    # ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ - Ð²Ñ‹ÑÐ¾ÐºÐ¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ CPU (>80% Ð¾Ñ‚ limit)
    - alert: PodHighCPUUsage
      expr: |
        (
          avg by(pod, container, namespace) (rate(container_cpu_usage_seconds_total{container!="POD",container!="",namespace=~"apps|infra"}[5m]))
          / 
          on(pod, container, namespace) group_left
          max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="cpu",container!="POD",container!=""})
        ) * 100 > 80
        and
        max by(pod, container, namespace) (kube_pod_container_resource_limits{resource="cpu",container!="POD",container!=""}) > 0
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "Pod {{ $labels.pod }} is using {{ $value | humanize }}% of CPU limit"
        description: "Container {{ $labels.container }} in pod {{ $labels.pod }} (namespace {{ $labels.namespace }}) is using {{ $value | humanize }}% of its CPU limit. Consider increasing limits or optimizing CPU usage."

