apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: traefik-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: traefik
    interval: 5s
    rules:
    - alert: TraefikServiceDown
      expr: count(traefik_service_server_up) by (service) == 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: Traefik service down (instance {{ $labels.instance }})
        description: "All Traefik services are down\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"

    - alert: TraefikHighHttp4xxErrorRateService
      expr: |
        (
          sum(rate(traefik_service_requests_total{code=~"4.*"}[5m])) by (service)
          /
          sum(rate(traefik_service_requests_total[5m])) by (service)
        ) * 100 > 5
        and
        sum(rate(traefik_service_requests_total[5m])) by (service) > 0.1
      for: 7m
      labels:
        severity: critical
      annotations:
        summary: Traefik high HTTP 4xx error rate service (instance {{ $labels.instance }})
        description: "Traefik service 4xx error rate is above 5% ({{ $value | humanize }}%)\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"

    - alert: TraefikHighHttp5xxErrorRateService
      expr: |
        (
          sum(rate(traefik_service_requests_total{code=~"5.*"}[5m])) by (service)
          /
          sum(rate(traefik_service_requests_total[5m])) by (service)
        ) * 100 > 5
        and
        sum(rate(traefik_service_requests_total[5m])) by (service) > 0.1
      for: 7m
      labels:
        severity: critical
      annotations:
        summary: Traefik high HTTP 5xx error rate service (instance {{ $labels.instance }})
        description: "Traefik service 5xx error rate is above 5% ({{ $value | humanize }}%)\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"

    - alert: TraefikHighHttp403ErrorRate
      expr: sum(rate(traefik_service_requests_total{code="403"}[5m])) by (service) > 10
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High 403 error rate on {{ $labels.service }}"
        description: "Possible brute force attack detected. 403 errors: {{ $value }}/s on service {{ $labels.service }}"

    - alert: TraefikBruteForceAttack
      expr: sum(rate(traefik_service_requests_total{code="403"}[1m])) by (service) > 50
      for: 2m
      labels:
        severity: critical
      annotations:
        summary: "ðŸš¨ Possible brute force attack on {{ $labels.service }}"
        description: "Very high 403 error rate: {{ $value }}/s on service {{ $labels.service }}. Consider checking logs and blocking IPs."

    - alert: TraefikRateLimitTriggered
      expr: sum(rate(traefik_service_requests_total{code="429"}[5m])) by (service) > 1
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "Rate limit triggered on {{ $labels.service }}"
        description: "Rate limiting is active: {{ $value }}/s requests with 429 status on service {{ $labels.service }}. Possible attack or legitimate traffic spike."

    - alert: TraefikHighRateLimitRate
      expr: sum(rate(traefik_service_requests_total{code="429"}[5m])) by (service) > 10
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "ðŸš¨ High rate limit rate on {{ $labels.service }}"
        description: "Very high rate of rate-limited requests: {{ $value }}/s on service {{ $labels.service }}. Likely brute force attack or DDoS attempt."

    # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð»ÐµÑ€Ñ‚ - Ingress backend Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ 5xx Ð¾ÑˆÐ¸Ð±ÐºÐ¸
    - alert: IngressBackendDown
      expr: |
        (
          sum(rate(traefik_service_requests_total{code=~"5.."}[5m])) by (service)
          /
          sum(rate(traefik_service_requests_total[5m])) by (service)
        ) > 0.9
        and
        sum(rate(traefik_service_requests_total[5m])) by (service) > 0.1
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Ingress backend {{ $labels.service }} is returning mostly 5xx errors"
        description: "Service {{ $labels.service }} is returning {{ $value | humanize }}% 5xx errors. Check pod status and service endpoints."
