apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: database-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: postgres
    interval: 30s
    rules:
    - alert: PostgreSQLDown
      expr: up{job="postgres-exporter"} == 0
      for: 3m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL DOWN on {{ $labels.host }}"
        description: "Cannot scrape PostgreSQL metrics for 3 minutes."

    - alert: PostgreSQLReplicationLag
      expr: |
        (
          pg_replication_lag_seconds > 10
        )
        * on(instance) group_left
          pg_static
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "PostgreSQL replication lag high on {{ $labels.host }}"
        description: |
          **Lag:** {{ $value }} seconds
          **Host:** {{ $labels.host }}
          **Instance:** {{ $labels.instance }}
          **Action:** âš ï¸ Check replica status

    - alert: PostgreSQLHighConnections
      expr: |
        (
          pg_stat_database_numbackends{datname="postgres"} > 10
        )
        * on(instance) group_left
          pg_static
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL high connection count"
        description: |
          **Connections:** {{ $value }}
          **Database:** {{ $labels.datname }}
          **Host:** {{ $labels.host }}
          **Action:** ðŸš¦ Check connection pool

    - alert: PostgreSQLDeadlocks
      expr: |
        (
          increase(pg_stat_database_deadlocks[5m]) > 0
        )
        * on(instance, datname) group_left
          pg_stat_database_size_bytes
      for: 0m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL deadlocks detected on {{ $labels.datname }}"
        description: |
          **Database:** {{ $labels.datname }}
          **Deadlocks:** {{ $value }}
          **Instance:** {{ $labels.instance }}
          **Action:** ðŸ”’ Review transaction isolation

    - alert: PostgreSQLDatabaseSize
      expr: |
        (
          pg_database_size_bytes / (1024^3) > 10
        )
        * on(instance, datname) group_left
          pg_database_size_bytes
      for: 1h
      labels:
        severity: info
      annotations:
        summary: "PostgreSQL database {{ $labels.datname }} > 10GB"
        description: |
          **Database:** {{ $labels.datname }}
          **Size:** {{ $value | humanize }}GB
          **Instance:** {{ $labels.instance }}

  - name: mysql
    interval: 30s
    rules:
    - alert: MySQLDown
      expr: up{job="mysql-exporter"} == 0
      for: 3m
      labels:
        severity: critical
      annotations:
        summary: "MySQL DOWN on {{ $labels.host }}"
        description: "Cannot reach MySQL at {{ $labels.instance }}."

    - alert: MySQLReplicationLagCritical
      expr: |
        (
          mysql_slave_status_seconds_behind_source > 30
        )
        * on(instance) group_left
          mysql_version_info
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "MySQL replication lag CRITICAL on {{ $labels.host }}"
        description: |
          **Lag:** {{ $value }} seconds
          **Host:** {{ $labels.hostname }}
          **Master:** {{ $labels.master_host }}
          **Action:** ðŸš¨ Replica is falling behind!

    - alert: MySQLReplicationStopped
      expr: |
        (
          mysql_slave_status_replica_io_running == 0
          or
          mysql_slave_status_replica_sql_running == 0
        )
        * on(instance) group_left
          mysql_version_info
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "MySQL replication STOPPED on {{ $labels.host }}"
        description: |
          **IO Running:** {{ $labels.mysql_slave_status_replica_io_running }}
          **SQL Running:** {{ $labels.mysql_slave_status_replica_sql_running }}
          **Host:** {{ $labels.hostname }}
          **Action:** ðŸ”„ Restart replication threads

    - alert: MySQLReplicationLagWarning
      expr: |
        (
          mysql_slave_status_seconds_behind_source > 5
        )
        * on(instance) group_left
          mysql_version_info
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "MySQL replication lag warning on {{ $labels.host }}"
        description: |
          **Lag:** {{ $value }} seconds
          **Host:** {{ $labels.hostname }}
          **Action:** âš ï¸ Monitor replication performance

    - alert: MysqlTooManyConnections(>80%)
      expr: max_over_time(mysql_global_status_threads_connected[1m]) / mysql_global_variables_max_connections * 100 > 80
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: MySQL too many connections (> 80%) (instance {{ $labels.instance }})
        description: "More than 80% of MySQL connections are in use on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
    - alert: MysqlHighThreadsRunning
      expr: max_over_time(mysql_global_status_threads_running[1m]) / mysql_global_variables_max_connections * 100 > 60
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: MySQL high threads running (instance {{ $labels.instance }})
        description: "More than 60% of MySQL connections are in running state on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
    - alert: MysqlSlaveIoThreadNotRunning
      expr: ( mysql_slave_status_replica_io_running and ON (instance) mysql_slave_status_source_server_id > 0 ) == 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: MySQL Slave IO thread not running (instance {{ $labels.instance }})
        description: "MySQL Slave IO thread not running on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
    - alert: MysqlSlaveSqlThreadNotRunning
      expr: ( mysql_slave_status_replica_sql_running and ON (instance) mysql_slave_status_source_server_id > 0) == 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: MySQL Slave SQL thread not running (instance {{ $labels.instance }})
        description: "MySQL Slave SQL thread not running on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
    - alert: MysqlRestarted
      expr: mysql_global_status_uptime < 60
      for: 0m
      labels:
        severity: info
      annotations:
        summary: MySQL restarted (instance {{ $labels.instance }})
        description: "MySQL has just been restarted, less than one minute ago on {{ $labels.instance }}.\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
    - alert: MysqlHighQps
      expr: irate(mysql_global_status_questions[1m]) > 5000
      for: 2m
      labels:
        severity: info
      annotations:
        summary: MySQL High QPS (instance {{ $labels.instance }})
        description: "MySQL is being overload with unusual QPS (> 10k QPS).\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"



  - name: redis
    interval: 30s
    rules:
    - alert: RedisDown
      expr: up{job="redis-exporter"} == 0
      for: 3m
      labels:
        severity: critical
      annotations:
        summary: "Redis DOWN on {{ $labels.host }}"
        description: "Cannot scrape Redis metrics."
