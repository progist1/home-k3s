apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: smartmon-rules
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: smartmon-health
    interval: 30s
    rules:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–µ—Ä—Ç: –¥–∏—Å–∫ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –Ω–µ–∑–¥–æ—Ä–æ–≤—ã–π
    - alert: SmartmonDeviceUnhealthy
      expr: |
        (
          smartmon_device_smart_healthy == 0
        )
        * on(disk) group_left
          smartmon_device_info
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "SMART health FAILED: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Type:** {{ $labels.type }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}N/A{{ end }}
          **Family:** {{ if $labels.model_family }}{{ $labels.model_family }}{{ else }}N/A{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Firmware:** {{ $labels.firmware_version }}
          **Host:** {{ $labels.hostname }}
          **Action:** üö® Replace drive immediately!
        
    # –í–Ω–∏–º–∞–Ω–∏–µ: –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Å–µ–∫—Ç–æ—Ä–∞ (–∫—Ä–∏—Ç–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å)
    - alert: SmartmonReallocatedSectors
      expr: |
        (
          smartmon_reallocated_sector_ct_raw_value > 0
        )
        * on(disk) group_left
          smartmon_device_info
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Reallocated sectors: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Count:** {{ $value }} sectors
          **Host:** {{ $labels.hostname }}
          **Action:** ‚ö†Ô∏è Drive is failing, schedule replacement ASAP!
        
    # –í–Ω–∏–º–∞–Ω–∏–µ: —Å–µ–∫—Ç–æ—Ä–∞ –æ–∂–∏–¥–∞—é—Ç –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
    - alert: SmartmonPendingSectors
      expr: |
        (
          smartmon_current_pending_sector_raw_value > 0
        )
        * on(disk) group_left
          smartmon_device_info
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Pending sectors: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Pending:** {{ $value }} sectors
          **Host:** {{ $labels.hostname }}
          **Risk:** üî• Data loss possible, backup immediately!
        
    # –í–Ω–∏–º–∞–Ω–∏–µ: –Ω–µ–∏—Å–ø—Ä–∞–≤–∏–º—ã–µ –æ—à–∏–±–∫–∏
    - alert: SmartmonOfflineUncorrectable
      expr: |
        (
          smartmon_offline_uncorrectable_raw_value > 0
        )
        * on(disk) group_left
          smartmon_device_info
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Uncorrectable errors: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Errors:** {{ $value }} uncorrectable sectors
          **Host:** {{ $labels.hostname }}
          **Action:** üíæ Immediate backup recommended!

  - name: smartmon-performance
    interval: 30s
    rules:
    # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
    - alert: SmartmonHighTemperature
      expr: |
        (
          smartmon_temperature_celsius_raw_value > 55
        )
        * on(disk) group_left
          smartmon_device_info
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "High temperature: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Temp:** {{ $value }}¬∞C
          **Host:** {{ $labels.hostname }}
          **Threshold:** 55¬∞C
          **Action:** üå°Ô∏è Check cooling/ventilation!
        
    # –û—à–∏–±–∫–∏ UDMA CRC (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞–±–µ–ª–µ–º/–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º)
    - alert: SmartmonUDMACRCError
      expr: |
        (
          increase(smartmon_udma_crc_error_count_raw_value[1h]) > 0
        )
        * on(disk) group_left
          smartmon_device_info
      for: 0m
      labels:
        severity: warning
      annotations:
        summary: "UDMA CRC errors: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Errors:** {{ $value }} in last hour
          **Host:** {{ $labels.hostname }}
          **Issue:** üîå Cable or controller problem detected

  - name: smartmon-wear
    interval: 30s
    rules:
    # –î–ª—è SSD: –∏–∑–Ω–æ—Å (–µ—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ç—Ä–∏–∫–∞)
    - alert: SmartmonSSDwearHigh
      expr: |
        (
          smartmon_wear_leveling_count_raw_value > 90
        )
        * on(disk) group_left
          smartmon_device_info
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "SSD wear high: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Wear level:** {{ $value }}%
          **Host:** {{ $labels.hostname }}
          **Action:** üîÑ Consider SSD replacement soon

  - name: smartmon-nvme
    interval: 30s
    rules:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∏–∑–Ω–æ—Å NAND (–ø–æ—Ä–æ–≥ 80%)
    - alert: NVMeHighPercentageUsed
      expr: |
        (
          smartmon_percentage_used > 80
        )
        * on(disk) group_left
          smartmon_device_info
      for: 1h
      labels:
        severity: warning
      annotations:
        summary: "NVMe wear high: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Wear:** {{ $value }}%
          **Host:** {{ $labels.hostname }}
          **Action:** üîÑ Consider SSD replacement soon

    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞–ø–∞—Å–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (<20%)
    - alert: NVMeLowAvailableSpareCritical
      expr: |
        (
          smartmon_available_spare_percentage < 20
        )
        * on(disk) group_left
          smartmon_device_info
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "CRITICAL spare blocks low: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Available spare:** {{ $value }}%
          **Host:** {{ $labels.hostname }}
          **Action:** üö® Backup data NOW, drive failure imminent!

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–ø–∞—Å–Ω—ã—Ö –±–ª–æ–∫–∞—Ö (<50%)
    - alert: NVMeLowAvailableSpareWarning
      expr: |
        (
          smartmon_available_spare_percentage < 50
        )
        * on(disk) group_left
          smartmon_device_info
      for: 15m
      labels:
        severity: warning
      annotations:
        summary: "Low spare blocks: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Available spare:** {{ $value }}%
          **Host:** {{ $labels.hostname }}
          **Action:** ‚ö†Ô∏è Monitor drive closely

    # –í—Å–ø–ª–µ—Å–∫ unsafe shutdowns (>5 –∑–∞ –¥–µ–Ω—å)
    - alert: NVMeHighUnsafeShutdowns
      expr: |
        (
          increase(smartmon_unsafe_shutdown_count_raw_value[1d]) > 5
        )
        * on(disk) group_left
          smartmon_device_info
      for: 0m
      labels:
        severity: warning
      annotations:
        summary: "Unsafe shutdowns spike: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Recent unsafe shutdowns:** {{ $value }}
          **Host:** {{ $labels.hostname }}
          **Issue:** üí° Check power supply/UPS

    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (>70¬∞C)
    - alert: NVMeCriticalTemperature
      expr: |
        (
          smartmon_temperature_celsius_raw_value > 70
        )
        * on(disk) group_left
          smartmon_device_info
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "CRITICAL temp: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Temp:** {{ $value }}¬∞C
          **Host:** {{ $labels.hostname }}
          **Action:** üî• Throttling imminent, improve cooling!

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã (>60¬∞C)
    - alert: NVMeHighTemperature
      expr: |
        (
          smartmon_temperature_celsius_raw_value > 60
        )
        * on(disk) group_left
          smartmon_device_info
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "High temperature: {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}"
        description: |
          **Device:** {{ $labels.disk }}
          **Model:** {{ if $labels.device_model }}{{ $labels.device_model }}{{ else }}{{ $labels.type }}{{ end }}
          **Serial:** {{ $labels.serial_number }}
          **Temp:** {{ $value }}¬∞C
          **Host:** {{ $labels.hostname }}
          **Action:** üå°Ô∏è Monitor cooling

    # –ü–µ—Ä–µ—Å—Ç–∞–ª –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è smart
    - alert: SmartmonStaled
      expr: |
        time() - smartmon_data_collection_timestamp
      for: 10m
      labels:
        severity: critical
      annotations:
        summary: "Smartmon data staled"
        description: |
          Smartmon staled for {{ $value }} seconds

    # –ü–∏—à–µ–º –º–Ω–æ–≥–æ –Ω–∞ nvme
    - alert: NVMeHighTBWIncrease
      expr: |
        increase(nvme_data_units_written_total[24h]) * 512000 / 10^12
      for: 1h
      labels:
        severity: critical
      annotations:
        summary: "High write rate on {{ $labels.device }}"
        description: |
          TBW increase: {{ $value }} per 24h
