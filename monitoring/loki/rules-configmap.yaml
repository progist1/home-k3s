apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-rules-auth
  namespace: monitoring
  labels:
    loki_rule: "1"  # Sidecar ищет ConfigMap с этим label
    app.kubernetes.io/name: loki
    app.kubernetes.io/component: ruler
data:
  # Loki Ruler rules file
  # For single-tenant (auth_enabled: false), Loki uses "fake" tenant
  # Sidecar копирует файлы в /rules, затем они должны быть в /var/loki/rules/fake/
  fake: |
    groups:
      # ============================================
      # Immich OAuth Authentication
      # ============================================
      - name: immich_oauth
        interval: 1m
        rules:
          - alert: ImmichOAuthLoginActivity
            expr: |
              sum(count_over_time({namespace="apps",app_kubernetes_io_name="server"} |~ "POST /api/oauth/(authorize|callback)" |~ "20[01]" [5m])) > 0
            for: 0s
            labels:
              severity: info
              service: immich
              alert_type: auth_success
            annotations:
              summary: "Immich OAuth authentication detected"
              description: "Immich: {{ $value }} OAuth login(s) detected in last 5 minutes"

          - alert: ImmichHighOAuthActivity
            expr: |
              sum(count_over_time({namespace="apps",app_kubernetes_io_name="server"} |~ "POST /api/oauth/" [5m])) > 5
            for: 2m
            labels:
              severity: warning
              service: immich
              alert_type: suspicious_activity
            annotations:
              summary: "Immich: Suspicious OAuth activity detected"
              description: "Immich: {{ $value }} OAuth requests in last 5 minutes (threshold: 5)"

      # ============================================
      # Authentik Authentication Flow
      # ============================================
      - name: authentik_auth
        interval: 1m
        rules:
          - alert: AuthentikAuthenticationActivity
            expr: |
              sum(count_over_time({namespace="apps",app_kubernetes_io_instance="authentik",app_kubernetes_io_name="authentik",app_kubernetes_io_component="server",container="server"} |~ "POST" |~ "flows/executor" [5m])) > 0
            for: 0s
            labels:
              severity: info
              service: authentik
              alert_type: auth_attempts
            annotations:
              summary: "Authentik authentication activity detected"
              description: "Authentik: {{ $value }} authentication flow(s) executed in last 5 minutes"

          - alert: AuthentikSuccessfulLogin
            expr: |
              sum(count_over_time({namespace="apps",app_kubernetes_io_instance="authentik",app_kubernetes_io_name="authentik",app_kubernetes_io_component="server",container="server"} |~ "action.*login" [5m])) > 0
            for: 0s
            labels:
              severity: info
              service: authentik
              alert_type: auth_success
            annotations:
              summary: "Authentik successful login detected"
              description: "Authentik: {{ $value }} successful login(s) detected in last 5 minutes"

          - alert: AuthentikHighAuthenticationActivity
            expr: |
              sum(count_over_time({namespace="apps",app_kubernetes_io_instance="authentik",app_kubernetes_io_name="authentik",app_kubernetes_io_component="server",container="server"} |~ "POST" |~ "flows/executor" [5m])) > 3
            for: 5m
            labels:
              severity: warning
              service: authentik
              alert_type: suspicious_activity
            annotations:
              summary: "Authentik: Suspicious authentication activity detected"
              description: "Authentik: {{ $value }} flow executions in last 5 minutes (threshold: 3)"

      # ============================================
      # PhotoPrism Authentication
      # ============================================
      - name: photoprism_auth
        interval: 1m
        rules:
          - alert: PhotoPrismSuccessfulLogins
            expr: |
              sum(count_over_time({namespace="apps",app="photoprism"} |~ "POST /api/v1/session \\(200\\)" [5m])) > 0
            for: 0s
            labels:
              severity: info
              service: photoprism
              alert_type: auth_success
            annotations:
              summary: "PhotoPrism: Successful authentication detected"
              description: "PhotoPrism: {{ $value }} successful login(s) detected in last 5 minutes"

          - alert: PhotoPrismFailedLoginAttempts
            expr: |
              sum(count_over_time({namespace="apps",app="photoprism"} |~ "POST /api/v1/session \\(401\\)" [5m])) > 3
            for: 2m
            labels:
              severity: warning
              service: photoprism
              alert_type: auth_failures
            annotations:
              summary: "PhotoPrism: Multiple failed login attempts detected"
              description: "PhotoPrism: {{ $value }} failed login attempts in last 5 minutes (threshold: 3)"

          - alert: PhotoPrismBruteForceAttack
            expr: |
              sum(count_over_time({namespace="apps",app="photoprism"} |~ "POST /api/v1/session \\(401\\)" [5m])) > 10
            for: 5m
            labels:
              severity: critical
              service: photoprism
              alert_type: brute_force
            annotations:
              summary: "PhotoPrism: CRITICAL - Brute force attack detected"
              description: "PhotoPrism: {{ $value }} failed login attempts in last 5 minutes (threshold: 10) - possible brute force attack"

      # ============================================
      # Jellyfin Authentication
      # ============================================
      - name: jellyfin_auth
        interval: 1m
        rules:
          - alert: JellyfinSuccessfulLogin
            expr: |
              sum by (user) (
                count_over_time(
                  {namespace="apps",app="jellyfin",container="jellyfin"} 
                  |~ "Authentication request" 
                  |~ "succeeded"
                  | regex "for (?P<user>[a-zA-Z0-9_]+) has succeeded"
                  [5m]
                )
              ) > 0
            for: 0s
            labels:
              severity: info
              service: jellyfin
              alert_type: auth_success
            annotations:
              summary: "Jellyfin: User {{ $labels.user }} successfully authenticated"
              description: "Jellyfin: User '{{ $labels.user }}' has successfully logged in ({{ $value }} login(s) in last 5 minutes)"

          - alert: JellyfinFailedLoginAttempts
            expr: |
              sum by (user) (
                count_over_time(
                  {namespace="apps",app="jellyfin",container="jellyfin"} 
                  |~ "Authentication request" 
                  |~ "failed"
                  | regex "for (?P<user>[a-zA-Z0-9_]+) has failed"
                  [5m]
                )
              ) > 3
            for: 2m
            labels:
              severity: warning
              service: jellyfin
              alert_type: auth_failures
            annotations:
              summary: "Jellyfin: Multiple failed login attempts for user {{ $labels.user }}"
              description: "Jellyfin: User '{{ $labels.user }}' has {{ $value }} failed login attempts in last 5 minutes (threshold: 3)"

          - alert: JellyfinBruteForceAttack
            expr: |
              sum by (user) (
                count_over_time(
                  {namespace="apps",app="jellyfin",container="jellyfin"} 
                  |~ "Authentication request" 
                  |~ "failed"
                  | regex "for (?P<user>[a-zA-Z0-9_]+) has failed"
                  [5m]
                )
              ) > 10
            for: 5m
            labels:
              severity: critical
              service: jellyfin
              alert_type: brute_force
            annotations:
              summary: "Jellyfin: CRITICAL - Brute force attack detected for user {{ $labels.user }}"
              description: "Jellyfin: User '{{ $labels.user }}' has {{ $value }} failed login attempts in last 5 minutes (threshold: 10) - possible brute force attack"

