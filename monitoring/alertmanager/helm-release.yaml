apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  interval: 1h
  chart:
    spec:
      chart: alertmanager
      version: "1.23.1"
      sourceRef:
        kind: HelmRepository
        name: prometheus
        namespace: flux-system
  values:
    config:
      global:
        resolve_timeout: 5m

      route:
        receiver: telegram
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 3h

      receivers:
        - name: telegram
          telegram_configs:
            - chat_id: 22183219
              bot_token_file: "/etc/alertmanager/secrets/telegram_token"
              parse_mode: "HTML"
              send_resolved: true

    service:
      type: ClusterIP
    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: root-ca-issuer
        traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
        traefik.ingress.kubernetes.io/router.middlewares: infra-redirect-to-https@kubernetescrd
      hosts:
        - host: alerts.home
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - alerts.home
          secretName: alertmanager-internal-tls
    persistence:
      enabled: true
      existingClaim: alertmanager-storage-pvc
    extraSecretMounts:
      - name: alertmanager-telegram-token
        mountPath: /etc/alertmanager/secrets
        secretName: alertmanager-secrets
        readOnly: true
