apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tdarr-node
  namespace: apps
spec:
  serviceName: tdarr-node
  replicas: 1
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
  selector:
    matchLabels:
      app: tdarr-node
  template:
    metadata:
      labels:
        app: tdarr-node
    spec:
      # Одна iGPU — одна реплика; при 1 транскоде + 1 хелсчеке Video уже ~100%, добавлять ноды нет смысла
      nodeSelector:
        node.hardware.gpu: intel-igpu
        node.workload.class: gpu
      tolerations:
        - key: node.hardware.gpu
          operator: Equal
          value: intel-igpu
          effect: NoSchedule

      # securityContext не задаём — образ использует s6-applyuidgid, иначе "unable to set supplementary group list: Operation not permitted"
      containers:
        - name: tdarr-node
          image: ghcr.io/haveagitgat/tdarr_node:2.59.02
          env:
            - name: TZ
              value: Europe/Moscow
            - name: inContainer
              value: "true"
            - name: nodeName
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: serverURL
              value: "http://tdarr.apps.svc.cluster.local:8266"
            - name: transcodegpuWorkers
              value: "1"
            - name: transcodecpuWorkers
              value: "1"
            - name: healthcheckcpuWorkers
              value: "5"
          ports:
            - containerPort: 8267
          volumeMounts:
            - name: data
              mountPath: /app/configs
              subPath: configs
            - name: data
              mountPath: /app/logs
              subPath: logs
            - name: temp
              mountPath: /temp
            - name: media
              mountPath: /media
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
              gpu.intel.com/i915: "1"
            limits:
              cpu: "8"
              memory: "4Gi"
              gpu.intel.com/i915: "1"
          livenessProbe:
            # Node не слушает порты (только исходящее подключение к серверу); проверяем процесс
            exec:
              command: ["pgrep", "-x", "Tdarr_Node"]
            initialDelaySeconds: 90
            periodSeconds: 30
          readinessProbe:
            exec:
              command: ["pgrep", "-x", "Tdarr_Node"]
            initialDelaySeconds: 45
            periodSeconds: 15

      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: tdarr-node-data-pvc
        - name: temp
          persistentVolumeClaim:
            claimName: tdarr-node-temp-pvc
        - name: media
          persistentVolumeClaim:
            claimName: tdarr-server-media-pvc
