apiVersion: v1
kind: ConfigMap
metadata:
  name: immich-values
  namespace: apps
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
    reconcile.fluxcd.io/recreate: "true"
data:
  values.yaml: |
    env:
      REDIS_HOSTNAME: 'redis.apps.svc.cluster.local'
      REDIS_DBINDEX: "5"
      DB_HOSTNAME: "pgvecto.apps.svc.cluster.local"
      DB_PORT: "5432"
      IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'

    image:
      tag: v1.135.3

    immich:
      metrics:
        enabled: false
      persistence:
        library:
          existingClaim: immich-fast-pvc

    server:
      enabled: true
      image:
        repository: ghcr.io/immich-app/immich-server
        pullPolicy: IfNotPresent
      envFrom:
        - secretRef:
          name: immich-secrets
      persistence:
        backups:
          existingClaim: immich-hdd-pvc
          subPath: backups
          mountPath: /usr/src/app/upload/backups
        encodedVideo:
          existingClaim: immich-hdd-pvc
          subPath: encoded-video
          mountPath: /usr/src/app/upload/encoded-video
        libraryDummy:
          existingClaim: immich-hdd-pvc
          subPath: library
          mountPath: /usr/src/app/upload/library
        external:
          existingClaim: immich-photos-pvc
          mountPath: /mnt/photos

    machine-learning:
      enabled: true
      image:
        repository: ghcr.io/immich-app/immich-machine-learning
        pullPolicy: IfNotPresent
      env:
        TRANSFORMERS_CACHE: /cache
      persistence:
        cache:
          enabled: true
          existingClaim: immich-fast-ml-pvc
      envFrom:
        - secretRef:
          name: immich-secrets
