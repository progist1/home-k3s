apiVersion: v1
kind: ConfigMap
metadata:
  name: immich-values
  namespace: apps
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
    reconcile.fluxcd.io/recreate: "true"
data:
  values.yaml: |
    env:
      - name: REDIS_HOSTNAME
        value: 'redis.apps.svc.cluster.local'
      - name: REDIS_DBINDEX
        value: "5"
      - name: REDIS_PORT
        value: "6379"
      - name: IMMICH_PORT
        value: "2283"
      - name: DB_HOSTNAME
        value: "pgvecto.apps.svc.cluster.local"
      - name: DB_PORT
        value: "5432"
      - name: IMMICH_MACHINE_LEARNING_URL
        value: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'
      - name: DB_DATABASE_NAME
        valueFrom:
          secretKeyRef:
            name: immich-secrets
            key: DB_DATABASE_NAME
      - name: DB_PASSWORD
        valueFrom:
          secretKeyRef:
            name: immich-secrets
            key: DB_PASSWORD
      - name: DB_USERNAME
        valueFrom:
          secretKeyRef:
            name: immich-secrets
            key: DB_USERNAME

    image:
      tag: v1.135.3

    immich:
      metrics:
        enabled: false
      persistence:
        library:
          existingClaim: immich-upload-pvc

    server:
      enabled: true
      image:
        repository: ghcr.io/immich-app/immich-server
        pullPolicy: IfNotPresent
      envFrom:
        - secretRef:
            name: immich-secrets
      extraVolumes:
        - name: encoded-video
          persistentVolumeClaim:
            claimName: immich-hdd-pvc
        - name: backups
          persistentVolumeClaim:
            claimName: immich-hdd-pvc
        - name: library-dummy
          persistentVolumeClaim:
            claimName: immich-hdd-pvc
        - name: external-photos
          persistentVolumeClaim:
            claimName: immich-photos-pvc
      extraVolumeMounts:
        - name: encoded-video
          mountPath: /usr/src/app/upload/encoded-video
          subPath: encoded-video
        - name: backups
          mountPath: /usr/src/app/upload/backups
          subPath: backups
        - name: library-dummy
          mountPath: /usr/src/app/upload/library
          subPath: library
        - name: external-photos
          mountPath: /mnt/photos


    machine-learning:
      enabled: true
      image:
        repository: ghcr.io/immich-app/immich-machine-learning
        pullPolicy: IfNotPresent
      env:
        TRANSFORMERS_CACHE: /cache
      persistence:
        cache:
          enabled: true
          existingClaim: immich-fast-ml-pvc
      envFrom:
        - secretRef:
            name: immich-secrets
