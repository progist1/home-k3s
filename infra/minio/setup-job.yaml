apiVersion: batch/v1
kind: Job
metadata:
  name: minio-setup
  namespace: infra
  annotations:
    # Job будет пересоздан при изменении этого манифеста
    "fluxcd.io/ignore": "false"
spec:
  ttlSecondsAfterFinished: 3600  # Удалить через 1 час после завершения (для отладки)
  backoffLimit: 5  # Увеличиваем количество попыток
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Ждем готовности MinIO
        - name: wait-for-minio
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              until nc -z minio.infra.svc.cluster.local 9000; do
                echo "Waiting for MinIO..."
                sleep 2
              done
              echo "MinIO is ready!"
      containers:
        - name: mc
          image: minio/mc:RELEASE.2025-08-13T08-35-41Z
          command:
            - /bin/sh
            - -c
            - |
              set -e
              
              # ============================================
              # 1. Настройка MinIO клиента
              # ============================================
              echo "Configuring MinIO client..."
              mc alias set minio ${MINIO_HOST} "${MINIO_ACCESS_KEY}" "${MINIO_SECRET_KEY}"
              
              # ============================================
              # 2. Создание бакета
              # ============================================
              K8UP_BUCKET="${K8UP_BUCKET:-k8up-backups}"
              echo "Creating bucket ${K8UP_BUCKET}..."
              mc mb minio/${K8UP_BUCKET} --ignore-existing
              
              # ============================================
              # 3. Создание пользователя и политики (если credentials заданы)
              # ============================================
              if [ -n "${K8UP_ACCESS_KEY}" ] && [ -n "${K8UP_SECRET_KEY}" ]; then
                # 3.1. Создание/обновление пользователя
                echo "Creating user ${K8UP_ACCESS_KEY}..."
                mc admin user remove minio "${K8UP_ACCESS_KEY}" 2>&1 || true
                mc admin user add minio "${K8UP_ACCESS_KEY}" "${K8UP_SECRET_KEY}"
                
                # 3.2. Создание политики для бакета
                echo "Creating policy for bucket ${K8UP_BUCKET}..."
                POLICY_NAME="k8up-${K8UP_BUCKET}-policy"
                POLICY_JSON='{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:GetObject","s3:PutObject","s3:DeleteObject","s3:ListBucket","s3:GetBucketLocation"],"Resource":["arn:aws:s3:::'"${K8UP_BUCKET}"'/*","arn:aws:s3:::'"${K8UP_BUCKET}"'"]}]}'
                echo "$POLICY_JSON" > /tmp/k8up-policy.json
                
                mc admin policy remove minio "${POLICY_NAME}" 2>&1 || true
                mc admin policy create minio "${POLICY_NAME}" /tmp/k8up-policy.json
                
                # 3.3. Прикрепление политики к пользователю
                echo "Attaching policy to user..."
                mc admin policy detach minio "${POLICY_NAME}" --user "${K8UP_ACCESS_KEY}" 2>&1 || true
                mc admin policy attach minio "${POLICY_NAME}" --user "${K8UP_ACCESS_KEY}"
              fi
              
              # ============================================
              # 4. Создание бакета и пользователя для Loki
              # ============================================
              if [ -n "${LOKI_ACCESS_KEY}" ] && [ -n "${LOKI_SECRET_KEY}" ]; then
                LOKI_BUCKET="${LOKI_BUCKET:-loki}"
                echo "Creating bucket ${LOKI_BUCKET}..."
                mc mb minio/${LOKI_BUCKET} --ignore-existing
                
                echo "Creating user ${LOKI_ACCESS_KEY}..."
                mc admin user remove minio "${LOKI_ACCESS_KEY}" 2>&1 || true
                mc admin user add minio "${LOKI_ACCESS_KEY}" "${LOKI_SECRET_KEY}"
                
                echo "Creating policy for bucket ${LOKI_BUCKET}..."
                LOKI_POLICY_NAME="loki-${LOKI_BUCKET}-policy"
                LOKI_POLICY_JSON='{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:GetObject","s3:PutObject","s3:DeleteObject","s3:ListBucket","s3:GetBucketLocation"],"Resource":["arn:aws:s3:::'"${LOKI_BUCKET}"'/*","arn:aws:s3:::'"${LOKI_BUCKET}"'"]}]}'
                echo "$LOKI_POLICY_JSON" > /tmp/loki-policy.json
                
                mc admin policy remove minio "${LOKI_POLICY_NAME}" 2>&1 || true
                mc admin policy create minio "${LOKI_POLICY_NAME}" /tmp/loki-policy.json
                
                echo "Attaching policy to user..."
                mc admin policy detach minio "${LOKI_POLICY_NAME}" --user "${LOKI_ACCESS_KEY}" 2>&1 || true
                mc admin policy attach minio "${LOKI_POLICY_NAME}" --user "${LOKI_ACCESS_KEY}"
              fi
              
              # Проверка что бакеты созданы
              echo "Listing buckets:"
              mc ls minio/
              
              echo "Listing users:"
              mc admin user list minio
              
              echo "Setup completed successfully!"
          env:
            - name: MINIO_HOST
              value: http://minio.infra.svc.cluster.local:9000
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: root-user
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: root-password
            - name: K8UP_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: k8up-secrets
                  key: access-key
                  optional: true
            - name: K8UP_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: k8up-secrets
                  key: secret-key
                  optional: true
            - name: K8UP_BUCKET
              value: k8up-backups
            - name: LOKI_ACCESS_KEY
              value: loki-user
            - name: LOKI_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: loki-secrets
                  key: minio-password
                  optional: true
            - name: LOKI_BUCKET
              value: loki
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
      volumes:
        - name: secrets
          secret:
            secretName: minio-secrets

