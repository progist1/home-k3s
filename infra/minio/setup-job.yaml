# Job для декларативного создания бакетов и аккаунтов в MinIO
# Запускается один раз при первом развертывании или при изменении конфигурации
# Для повторного запуска: kubectl delete job minio-setup -n infra && kubectl apply -f setup-job.yaml

apiVersion: batch/v1
kind: Job
metadata:
  name: minio-setup
  namespace: infra
  annotations:
    # Job будет пересоздан при изменении этого манифеста
    "fluxcd.io/ignore": "false"
spec:
  ttlSecondsAfterFinished: 300  # Удалить через 5 минут после завершения
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        # Ждем готовности MinIO
        - name: wait-for-minio
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              until nc -z minio.infra.svc.cluster.local 9000; do
                echo "Waiting for MinIO..."
                sleep 2
              done
              echo "MinIO is ready!"
      containers:
        - name: mc
          image: minio/mc:RELEASE.2025-08-13T08-35-41Z
          command:
            - /bin/sh
            - -c
            - |              
              echo "Configuring MinIO client..."
              mc alias set minio ${MINIO_HOST} "${MINIO_ACCESS_KEY}" "${MINIO_SECRET_KEY}"
              
              echo "Testing connection..."
              mc admin info minio
              
              # Создание бакетов (idempotent - не ошибка если уже существует)
              echo "Creating buckets..."
              
              # Бакет для k8up backups
              mc mb minio/k8up-backups --ignore-existing || echo "Bucket k8up-backups already exists or error occurred"
              
              # Проверка что бакет создан
              echo "Listing buckets:"
              mc ls minio/
              
              # Настройка политик доступа для бакетов (если нужно)
              # mc anonymous set download minio/k8up-backups
              
              # Создание пользователей и политик (если нужно)
              # Пример: создание пользователя для k8up
              # mc admin user add minio k8up-user "${K8UP_ACCESS_KEY}" || true
              # mc admin policy attach minio readwrite --user k8up-user || true
              
              echo "Setup completed successfully!"
          env:
            - name: MINIO_HOST
              value: http://minio.infra.svc.cluster.local:9000
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: root-user
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: root-password
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "128Mi"
      volumes:
        - name: secrets
          secret:
            secretName: minio-secrets

